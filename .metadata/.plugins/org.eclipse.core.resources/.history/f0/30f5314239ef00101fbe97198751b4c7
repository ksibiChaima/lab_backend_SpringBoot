package com.example.demo.service;

import java.util.ArrayList;
import java.util.List;
import org.springframework.stereotype.Service;
import com.example.demo.beans.EventBean;
import com.example.demo.beans.OutilBean;
import com.example.demo.beans.PublicationBean;
import com.example.demo.dao.*;
import com.example.demo.entities.*;
import com.example.demo.proxies.*;
import lombok.AllArgsConstructor;

@Service
@AllArgsConstructor
public class MemberServiceImpl implements IMemberService {
    
    private MembreRepository memberRepository;
    private EtudiantRepository etudiantRepository;
    private EnseignantChercheurRepository enseignantChercheurRepository;
    private MembrePubRepository membrePubRepository;
    private MembreOutilRepository membreOutilRepository;
    private MembreEventRepository membreEventRepository;
    private PublicationProxyService publicationProxyService;
    private OutilProxyService outilProxyService;
    private EventProxyService eventProxyService;

    // ========== CRUD ==========
    @Override
    public Membre addMember(Membre m) {
        return memberRepository.save(m);
    }

    @Override
    public void deleteMember(Long id) {
        memberRepository.deleteById(id);
    }

    @Override
    public Membre updateMember(Membre p) {
        return memberRepository.saveAndFlush(p);
    }

    @Override
    public Membre findMember(Long id) {
        return memberRepository.findById(id).orElseThrow(
            () -> new RuntimeException("Membre non trouvé avec l'ID: " + id)
        );
    }

    @Override
    public List<Membre> findAll() {
        return memberRepository.findAll();
    }

    // ========== SEARCH ==========
    @Override
    public List<Membre> findByNom(String nom) {
        return memberRepository.findByNomStartingWith(nom);
    }

    @Override
    public Membre findByCin(String cin) {
        return memberRepository.findByCin(cin);
    }

    @Override
    public Membre findByEmail(String email) {
        return memberRepository.findByEmail(email);
    }

    @Override
    public List<Etudiant> findByDiplome(String diplome) {
        return etudiantRepository.findByDiplome(diplome);
    }

    @Override
    public List<EnseignantChercheur> findByGrade(String grade) {
        return enseignantChercheurRepository.findByGrade(grade);
    }

    // ========== RELATIONSHIPS ==========
    @Override
    public void affecterEtudiantEnseignant(Long idEtudiant, Long idEnseignant) {
        Etudiant etudiant = etudiantRepository.findById(idEtudiant).orElseThrow(
            () -> new RuntimeException("Étudiant non trouvé")
        );
        EnseignantChercheur enseignant = enseignantChercheurRepository.findById(idEnseignant).orElseThrow(
            () -> new RuntimeException("Enseignant non trouvé")
        );
        etudiant.setEncadrant(enseignant);
        memberRepository.save(etudiant);
    }

    @Override
    public List<Etudiant> chercherParEncadrant(EnseignantChercheur encadrant) {
        return etudiantRepository.findByEncadrant(encadrant);
    }

    // ========== PUBLICATIONS ==========
    @Override
    public void affecterauteurTopublication(Long idauteur, Long idpub) {
        Membre membre = memberRepository.findById(idauteur).orElseThrow(
            () -> new RuntimeException("Membre non trouvé")
        );
        Membre_Publication membrePub = new Membre_Publication();
        membrePub.setId(new Membre_Pub_Id(idpub, idauteur));
        membrePub.setAuteur(membre);
        membrePubRepository.save(membrePub);
    }

    @Override
    public List<PublicationBean> findPublicationparauteur(Long idauteur) {
        List<PublicationBean> pubs = new ArrayList<>();
        List<Membre_Publication> idpubs = membrePubRepository.findpubId(idauteur);
        
        idpubs.forEach(s -> {
            try {
                PublicationBean pub = publicationProxyService.findPublicationById(
                    s.getId().getPublication_id()
                );
                pubs.add(pub);
            } catch (Exception e) {
                System.err.println("Publication non trouvée: " + e.getMessage());
            }
        });
        
        return pubs;
    }

    // ========== OUTILS & EVENTS (NEW) ==========
    @Override
    public List<OutilBean> findOutilsParAuteur(Long membreId) {
        List<OutilBean> result = new ArrayList<>();
        List<Membre_Outil> membreOutils = membreOutilRepository.findOutilsByMembreId(membreId);
        
        membreOutils.forEach(mo -> {
            try {
                OutilBean outil = outilProxyService.findOneOutilById(
                    mo.getId().getOutil_id()
                );
                result.add(outil);
            } catch (Exception e) {
                System.err.println("Outil non trouvé: " + e.getMessage());
            }
        });
        
        return result;
    }

    @Override
    public List<EventBean> findEvenementsParMembre(Long membreId) {
        List<EventBean> result = new ArrayList<>();
        List<Membre_Event> membreEvents = membreEventRepository.findEventsByMembreId(membreId);
        
        membreEvents.forEach(me -> {
            try {
                EventBean event = eventProxyService.findOneEventById(
                    me.getId().getEvent_id()
                );
                result.add(event);
            } catch (Exception e) {
                System.err.println("Événement non trouvé: " + e.getMessage());
            }
        });
        
        return result;
    }
}